#!/usr/bin/env python

import os
import sys
import spidev
import time
import datetime

image = [
		[(255, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 255, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 255), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
		[(0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0), (0, 0, 0)],
	]

font = {
		"A" : [ [0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[1, 1, 1, 1, 1],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 0, 0, 0, 0]],
		"B" : [ [1, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[1, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[1, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],

		"0" : [ [0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 1, 1],
				[1, 0, 1, 0, 1],
				[1, 1, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"1" : [ [0, 0, 1, 0, 0],
				[0, 1, 1, 0, 0],
				[0, 0, 1, 0, 0],
				[0, 0, 1, 0, 0],
				[0, 0, 1, 0, 0],
				[0, 0, 1, 0, 0],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"2" : [ [0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[0, 0, 0, 0, 1],
				[0, 0, 0, 1, 0],
				[0, 0, 1, 0, 0],
				[0, 1, 0, 0, 0],
				[1, 1, 1, 1, 1],
				[0, 0, 0, 0, 0]],
		"3" : [ [1, 1, 1, 1, 1],
				[0, 0, 0, 1, 0],
				[0, 0, 1, 0, 0],
				[0, 0, 0, 1, 0],
				[0, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"4" : [ [0, 0, 0, 1, 0],
				[0, 0, 1, 1, 0],
				[0, 1, 0, 1, 0],
				[1, 0, 0, 1, 0],
				[1, 1, 1, 1, 1],
				[0, 0, 0, 1, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0]],
		"5" : [ [1, 1, 1, 1, 1],
				[1, 0, 0, 0, 0],
				[1, 1, 1, 1, 0],
				[0, 0, 0, 0, 1],
				[0, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"6" : [ [0, 0, 1, 1, 0],
				[0, 1, 0, 0, 0],
				[1, 0, 0, 0, 0],
				[1, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"7" : [ [1, 1, 1, 1, 1],
				[0, 0, 0, 0, 1],
				[0, 0, 0, 1, 0],
				[0, 0, 1, 0, 0],
				[0, 1, 0, 0, 0],
				[0, 1, 0, 0, 0],
				[0, 1, 0, 0, 0],
				[0, 0, 0, 0, 0]],
		"8" : [ [0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 0],
				[0, 0, 0, 0, 0]],
		"9" : [ [0, 1, 1, 1, 0],
				[1, 0, 0, 0, 1],
				[1, 0, 0, 0, 1],
				[0, 1, 1, 1, 1],
				[0, 0, 0, 0, 1],
				[0, 0, 0, 1, 0],
				[0, 1, 1, 0, 0],
				[0, 0, 0, 0, 0]],
		" " : [ [0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0]],
		":" : [ [0, 0, 0, 0, 0],
				[0, 1, 1, 0, 0],
				[0, 1, 1, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 1, 1, 0, 0],
				[0, 1, 1, 0, 0],
				[0, 0, 0, 0, 0],
				[0, 0, 0, 0, 0]],
	}

font_small = {
		"0" : [ [0,1,1,0],
				[1,0,0,1],
				[1,0,0,1],
				[1,0,0,1],
				[0,1,1,0]],
		"1" : [ [0,0,1,0],
				[0,0,1,0],
				[0,0,1,0],
				[0,0,1,0],
				[0,0,1,0]],
		"2" : [ [1,1,1,0],
				[0,0,0,1],
				[0,1,1,0],
				[1,0,0,0],
				[1,1,1,1]],
		"3" : [ [1,1,1,0],
				[0,0,0,1],
				[0,1,1,0],
				[0,0,0,1],
				[1,1,1,1]],
		"4" : [ [1,0,0,1],
				[1,0,0,1],
				[1,1,1,1],
				[0,0,0,1],
				[0,0,0,1]],
		"5" : [ [1,1,1,1],
				[1,0,0,0],
				[1,1,1,1],
				[0,0,0,1],
				[1,1,1,1]],
		"6" : [ [1,1,1,0],
				[1,0,0,0],
				[1,1,1,1],
				[1,0,0,1],
				[1,1,1,1]],
		"7" : [ [1,1,1,1],
				[0,0,0,1],
				[0,0,0,1],
				[0,0,0,1],
				[0,0,0,1]],
		"8" : [ [0,1,1,0],
				[1,0,0,1],
				[0,1,1,0],
				[1,0,0,1],
				[0,1,1,0]],
		"9" : [ [0,1,1,0],
				[1,0,0,1],
				[0,1,1,1],
				[0,0,0,1],
				[0,1,1,0]],
		":" : [ [0,0,0,0],
				[0,0,1,0],
				[0,0,0,0],
				[0,0,1,0],
				[0,0,0,0]],
		" " : [ [0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0]],
		}


if __name__ == "__main__":
	print("Testing SPI device")

	# The spi controller normally accepts only single continious writes, that
	# needs to change, for now just handle 1K data

	spi = spidev.SpiDev()
	spi.open(1, 0)
	spi.mode = 0
	# spi.max_speed_hz = 6000000
	spi.max_speed_hz = 3000000
	# spi.max_speed_hz = 1000000
	# spi.max_speed_hz = 10000

	def write_frame(frame):
		for i in range(8):
			out = [0xf0]
			for j in range(32):
				out.append(frame[j][i][0])
				out.append(frame[j][i][1])
				out.append(frame[j][i][2])
			r = spi.xfer2(out)

		out = [0x10]
		r = spi.xfer2(out)

	test = "12:34"

	while True:
		test = datetime.datetime.now().strftime("%H:%M:%S")
		# print(repr(test))
		# print(len(test))
		# print(repr(test))
		char = 0
		colour = (0x3f, 0, 0)
		for i in test:
			for x in range(4):
				for y in range(5):
					r = min(255, font_small[i][y][x] * colour[0])
					g = min(255, font_small[i][y][x] * colour[1])
					b = min(255, font_small[i][y][x] * colour[2])
					image[x + (char * 4)][y + (0)] = (r, g, b)
			char += 1

		write_frame(image)
		time.sleep(0.1)

	# set_pixel = 0
	# rgb = 0
	# while True:
		# write_frame(image)

		# time.sleep(0.01)
		# set_pixel += 1
		# if set_pixel >= (32 * 8):
			# set_pixel = 0
			# rgb += 1
			# if rgb >= 3:
				# rgb = 0

		# for i in range(8):
			# for j in range(32):
				# if rgb == 0:
					# image[j][i] = (255, 0, 0) if (i * 32 + j) == set_pixel else (0, 0, 0)
				# elif rgb == 1:
					# image[j][i] = (0, 255, 0) if (i * 32 + j) == set_pixel else (0, 0, 0)
				# elif rgb == 2:
					# image[j][i] = (0, 0, 255) if (i * 32 + j) == set_pixel else (0, 0, 0)

	spi.close()

